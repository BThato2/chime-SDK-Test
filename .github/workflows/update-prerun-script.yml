name: Update pre build script on Saucelabs

on:
  push
#  schedule:
#    - cron: '0 0 1 */2 *'

env:
  SAUCE_USERNAME: ${{secrets.SAUCE_USERNAME}}
  SAUCE_ACCESS_KEY: ${{secrets.SAUCE_ACCESS_KEY}}

jobs: 
  update-pre-run-script:
    name: Update pre run script on Saucelabs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Package
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - run: aws s3 cp s3://saucelabs-prebuild-script/script.sh ./
      - name: Update pre run script and create PRs
        run: |
          RESPONSE="$(curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" â€”location --request POST 'https://api.us-west-1.saucelabs.com/v1/storage/upload' --form 'payload=@"script.sh"' --form 'name="blur_replacement_script"')"
          SCRIPT_ID=$(jq -r '.item.id' <<< "$RESPONSE")
          echo "Updating integration tests pre-run script ID for origin branch"
          git branch update-pre-run-script-id
          git checkout update-pre-run-script-id
          sed -i -E "s/storage.*'/storage:$SCRIPT_ID'/g" ${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js
          rm -rf script.sh
      - uses: EndBug/add-and-commit@v9
        with:
          add: '${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js'
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          title: Update integration tests pre-run script ID
          branch: update-pre-run-script-id
          base: origin
      - run: |
          echo "Updating integration tests pre-run script ID for release-2.x branch"
          git checkout release-2.x
          git branch update-pre-run-script-id-2.x
          git checkout update-pre-run-script-id-2.x
          sed -i -E "s/storage.*'/storage:$SCRIPT_ID'/g" ${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js
          rm -rf script.sh
      - uses: EndBug/add-and-commit@v9
        with:
          add: '${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js'
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          title: Update integration tests pre-run script ID
          branch: update-pre-run-script-id-2.x
          base: release-2.x
