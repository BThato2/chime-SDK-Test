name: Update pre build script on Saucelabs

on:
  schedule:
    - cron: '*/10 * * * *'
#  schedule:
#    - cron: '0 0 1 */2 *'
permissions:
  contents: read
  pull-requests: write

env:
  SAUCE_USERNAME: ${{secrets.SAUCE_USERNAME}}
  SAUCE_ACCESS_KEY: ${{secrets.SAUCE_ACCESS_KEY}}

jobs:
  get-previous-version:
    name: Get Previous Major Version
    runs-on: ubuntu-latest
    outputs:
      previous_version_number: ${{ steps.get-version.outputs.version-number }}
    steps:
      - name: Checkout Package
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get Version
        id: get-version
        run: |
          current_version=$(.github/script/get-current-version)
          echo "::set-output name=version-number::$((${current_version%%.*} - 1))"

  update-pre-run-script:
    name: Update pre run script on Saucelabs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Package
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - run: aws s3 cp s3://saucelabs-prebuild-script/script.sh ./
      - name: Update pre run script and create PRs
        run: |
          RESPONSE="$(curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" —location --request POST 'https://api.us-west-1.saucelabs.com/v1/storage/upload' --form 'payload=@"script.sh"' --form 'name="blur_replacement_script"')"
          SCRIPT_ID=$(jq -r '.item.id' <<< "$RESPONSE")
          echo "Updating integration tests pre-run script ID for origin branch"
          sed -i -E "s/storage.*'/storage:$SCRIPT_ID'/g" ${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js
          rm -rf script.sh
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update integration tests pre-run script ID
          title: Update integration tests pre-run script ID
          branch: update-pre-run-script-id
          base: main
          delete-branch: true
  
  update-pre-run-script-previous-version:
    name: Update pre run script on Saucelabs for previous version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Package
        uses: actions/checkout@v3
        with:
          ref: "release-${{ needs.get-previous-version.outputs.previous_version_number }}.x"
          fetch-depth: 0
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - run: aws s3 cp s3://saucelabs-prebuild-script/script.sh ./
      - name: Update pre run script and create PRs
        run: |
          RESPONSE="$(curl -u "$SAUCE_USERNAME:$SAUCE_ACCESS_KEY" —location --request POST 'https://api.us-west-1.saucelabs.com/v1/storage/upload' --form 'payload=@"script.sh"' --form 'name="blur_replacement_script"')"
          SCRIPT_ID=$(jq -r '.item.id' <<< "$RESPONSE")
          echo "Updating integration tests pre-run script ID for origin branch"
          sed -i -E "s/storage.*'/storage:$SCRIPT_ID'/g" ${GITHUB_WORKSPACE}/integration/js/utils/WebdriverSauceLabs.js
          rm -rf script.sh
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Update integration tests pre-run script ID
          title: Update integration tests pre-run script ID
          branch: update-pre-run-script-id-previous-release
          delete-branch: true
